#!/bin/bash
scriptname="$(basename $0)"

lockdir="${XDG_RUNTIME_DIR:-${HOME}/.local/var}/${scriptname}.lock"
pidfile="${lockdir}/PID"
if mkdir ${lockdir} &> /dev/null; then
    trap "rm -rf ${lockdir}; pkill -RTMIN+4 i3blocks; exit 0" EXIT SIGHUP SIGINT SIGQUIT SIGTERM
    echo "$$" > ${pidfile}
else
    otherpid=$(cat ${pidfile} 2>/dev/null)
    othercmd=$(ps --no-headers --format command --pid ${otherpid} 2>/dev/null)
    if [[ "${othercmd}" =~ .*${scriptname}.* ]]; then
        echo "another instance of ${scriptname} is currently running." >&2
        exit 1
    fi
    # lock is stale, remove and try again...
    rm -rf ${lockdir}
    exec "$0" "$@"
fi

logdir="${HOME}/.local/var/log"
mkdir -p ${logdir}

logfile="${logdir}/${scriptname}.log"
exec 1>${logfile}
exec 2>&1

rundir="${XDG_RUNTIME_DIR:-${HOME}/.local/var/run}/${scriptname}"
mkdir -p ${rundir}

pkill -RTMIN+4 i3blocks

if nm-online && ping -c 1 8.8.8.8 2>&1 >/dev/null; then
    msmtp-runqueue.sh -m 5 && \
        rm -f ${rundir}/msmtp.error || touch ${rundir}/msmtp.error
    mbsync squid && \
        rm -f ${rundir}/mbsync.error || touch ${rundir}/mbsync.error
else
    rm -f ${rundir}/*.error
fi

epoch=$(date +%s)
newepoch=$(cat ${rundir}/newepoch 2>/dev/null)
compactepoch=$(cat ${rundir}/compactepoch 2>/dev/null)

if [[ ! "$newepoch" =~ ^[0-9]+$ ]] || [ "$(($epoch - $newepoch))" -gt 14400 ]; then
    notmuch new
    echo $epoch > ${rundir}/newepoch
fi

if [[ ! "$compactepoch" =~ ^[0-9]+$ ]] || [ "$(($epoch - $compactepoch))" -gt 86400 ]; then
    notmuch compact
    echo $epoch > ${rundir}/compactepoch
fi

exit 0
